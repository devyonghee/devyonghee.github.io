---
title: '[Modern Java in Action] Chapter7. 병렬 데이터 처리와 성능'
tags: [book, moder java in action]
categories: book
---

모던 자바 인 액션 7장에서는 스트림 병렬 처리에 대해서 소개하고 있다.
스트림으로 얼마나 쉽게 병렬로 처리하는지 포크/조인 프레임워크와 어떤 관계가 있는지 살펴본다.

<!--more-->

<br/>

## 7.1 병렬 스트림

컬렉션에 `parallelStream` 을 호출하면 병렬 스트림(parallel stream) 을 생성할 수 있다.  
병렬 스트림을 이용하면 각 멀티코어 프로세서가 일을 처리하도록 할당할 수 있다.  

- `parallel` 메서드를 호출하면 병렬 스트림으로 변환 (병렬로 수행한다는 불리언 플래그가 설정)
- 반대로 `sequential` 호출하면 순차 스트림으로 변환
- 상황에 따라 병렬화를 하는 것보다 적절한 자료구조를 선택하는 것이 중요(오토 박싱, 언박싱 등의 오버헤드 주의)
- 코어간 데이터 전송 시간보다 오래 걸리는 작업만 병렬로 수행하는 것이 바람직

### 병렬 스트림 효과적으로 사용하기

- 확신이 서지 않으면 직접 측정하라
  - 언제나 병렬 스트림이 빠르지 않기 때문에, 어느 것이 좋은지 모르겠다면 직접 성능을 측정하는 것이 바람직하다.
- 박싱을 주의하라
  - 자동 박싱과 언박싱은 성능을 크게 저하시킨다.
  - 가능하면 기본형 특화 스트림을 이용하자
- 순차 스트림보다 병렬 스트림에서 성능이 떨어지는 연산이 있다
  - `list`, `findFirst` 처럼 요소의 순서에 의존하는 연산은 병렬 스트림에서 비용이 크다.
  - 요소의 순서가 상관 없다면 `unordered` 로 비정렬된 스트림을 얻고 `limit`을 호출하는 것이 효율적이다.
- 스트림에서 수행하는 전체 파이프라인 연산 비용을 고려하라
  - 전체 처리 비용이 N(요소 수) * Q(처리 비용) 일 때, Q 가 높아지면 병렬 스트림으로 성능을 개선할 수 있는 가능성이 있다.
- 소량의 데이터에서는 병렬 스트림이 도움 되지 않는다. 
  - 병렬화 과정에서 생기는 부가 비용이 클 수 있다.
- 자료구조가 적절한지 확인하라.
  - 분할할 때 `LinkedList` 은 모든 요소 탐색, `ArrayList` 은 탐색하지 않고도 가능하기 때문에 `ArrayList`이 더 효율적
- 중간 연산이 스트림의 특성을 어떻게 바꾸는지에 따라 분해 과정의 성능이 달라질 수 있음
  - `SIZED` 스트림은 정확히 같은 크기의 스트림으로 분할할 수 있어서 효율적으로 병렬 처리 가능
  - 필터 연산이 존재하면 길이를 예측할 수 없어서 효과적으로 병렬 처리가 가능한지 알 수 없음
- 최종 연산의 병합 과정 비용을 살펴보라
  - 병합 과정의 비용이 비싸다면 오히려 병렬 스트림으로 얻은 이익이 상쇄될 수 있음 

